<!-- views/phonebook.ejs -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css"
/>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

<style>
  .contact-groups {
    border-right: 1px solid #dee2e6;
    height: calc(100vh - 200px);
    overflow-y: auto;
  }
  .contact-list {
    height: calc(100vh - 200px);
    overflow-y: auto;
  }
  .group-item {
    cursor: pointer;
    padding: 10px 15px;
    border-bottom: 1px solid #dee2e6;
  }
  .group-item:hover {
    background-color: #f8f9fa;
  }
  .group-item.active {
    background-color: #128c7e;
    color: white;
  }
  .group-form {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }
</style>

<!-- Tambahkan link untuk Select2 -->
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Phone Book</h3>
  </div>
  <div class="card-body">
    <div class="row">
      <!-- Kolom Grup Kontak -->
      <div class="col-md-4 contact-groups">
        <!-- Form Tambah Grup -->
        <div class="group-form">
          <h5>Tambah Grup Baru</h5>
          <form id="groupForm">
            <div class="form-group">
              <input
                type="text"
                class="form-control"
                id="groupName"
                placeholder="Nama Grup"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">
              <i class="fas fa-plus"></i> Tambah Grup
            </button>
          </form>

          <!-- Tambahkan search box untuk grup -->
          <div class="form-group mt-3">
            <input
              type="text"
              class="form-control"
              id="groupSearch"
              placeholder="Cari Grup..."
            />
          </div>
        </div>

        <!-- Daftar Grup -->
        <div id="groupList">
          <!-- Grup akan dimuat secara dinamis -->
        </div>
      </div>

      <!-- Kolom Daftar Kontak -->
      <div class="col-md-8 contact-list">
        <div id="contactSection" style="display: none">
          <!-- Form untuk menambahkan kontak -->
          <form id="phoneBookForm" class="mb-4">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="name">Nama</label>
                  <input
                    type="text"
                    class="form-control"
                    id="name"
                    name="name"
                    required
                  />
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="country_code" class="form-label"
                    >Kode Negara</label
                  >
                  <select
                    class="form-select"
                    id="country_code"
                    name="country_code"
                  >
                    <option value="62" selected>Indonesia (+62)</option>
                    <option value="60">Malaysia (+60)</option>
                    <option value="65">Singapore (+65)</option>
                    <option value="66">Thailand (+66)</option>
                    <option value="84">Vietnam (+84)</option>
                    <option value="63">Philippines (+63)</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="phone">Nomor Telepon</label>
                  <input
                    type="text"
                    class="form-control"
                    id="phone"
                    name="phone"
                    required
                  />
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label>&nbsp;</label>
                  <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-plus"></i> Tambah
                  </button>
                </div>
              </div>
            </div>
            <input type="hidden" id="edit_id" name="edit_id" />
            <input type="hidden" id="group_id" name="group_id" />
          </form>

          <!-- Tabel kontak -->
          <div class="table-responsive">
            <table
              id="phoneBookTable"
              class="table table-bordered table-hover"
              style="width: 100%"
            >
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>Nomor Telepon</th>
                  <th width="100">Aksi</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data akan dimuat secara dinamis -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pesan saat belum memilih grup -->
        <div id="noGroupSelected" class="text-center py-5">
          <i class="fas fa-users fa-3x text-muted"></i>
          <p class="mt-3 text-muted">
            Pilih grup kontak di sebelah kiri untuk melihat daftar kontak
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Inisialisasi Select2 untuk kode negara
    $("#country_code").select2({
      width: "100%",
      minimumResultsForSearch: 1, // Menonaktifkan pencarian
    });

    // Load daftar grup
    function loadGroups() {
      const searchTerm = $("#groupSearch").val().toLowerCase();
      $.get("/contact-groups", function (groups) {
        const groupList = $("#groupList");
        groupList.empty();

        groups.forEach((group) => {
          const groupElement = $(`
          <div class="group-item" data-id="${group.id}">
            <div class="d-flex justify-content-between align-items-center">
              <span>${group.name}</span>
              <button class="btn btn-danger btn-sm delete-group" data-id="${group.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `);

          // Terapkan filter pencarian saat memuat ulang
          if (!searchTerm || group.name.toLowerCase().includes(searchTerm)) {
            groupElement.show();
          } else {
            groupElement.hide();
          }

          groupList.append(groupElement);
        });
      });
    }

    // Handle klik grup
    $("#groupList").on("click", ".group-item", function () {
      const groupId = $(this).data("id");
      $(".group-item").removeClass("active");
      $(this).addClass("active");
      $("#group_id").val(groupId);

      $("#noGroupSelected").hide();
      $("#contactSection").show();

      // Reload tabel dengan filter grup
      $("#phoneBookTable").DataTable().ajax.reload();
    });

    // Inisialisasi DataTable
    $("#phoneBookTable").DataTable({
      serverSide: true,
      processing: true,
      ajax: {
        url: "/phonebook/data",
        type: "GET",
        data: function (d) {
          d.group_id = $("#group_id").val();
        },
      },
      columns: [
        { data: "name" },
        { data: "phone" },
        {
          data: null,
          render: function (data, type, row) {
            return `
            <button class="btn btn-warning btn-sm btn-edit" data-id="${row.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm btn-delete" data-id="${row.id}">
              <i class="fas fa-trash"></i>
            </button>
          `;
          },
        },
      ],
      pageLength: 10,
      lengthChange: false,
      dom: "Bfrtip",
      buttons: [
        {
          extend: "excel",
          text: '<i class="fas fa-file-excel"></i> Export Excel',
          className: "btn btn-success btn-sm",
        },
        {
          extend: "csv",
          text: '<i class="fas fa-file-csv"></i> Export CSV',
          className: "btn btn-info btn-sm",
        },
      ],
      language: {
        processing: "Memproses...",
        search: "Cari:",
        lengthMenu: "Tampilkan _MENU_ data",
        info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
        infoEmpty: "Menampilkan 0 sampai 0 dari 0 data",
        infoFiltered: "(disaring dari _MAX_ data keseluruhan)",
        infoPostFix: "",
        loadingRecords: "Memuat...",
        zeroRecords: "Tidak ditemukan data yang sesuai",
        emptyTable: "Tidak ada data yang tersedia",
        paginate: {
          first: "Pertama",
          previous: "Sebelumnya",
          next: "Selanjutnya",
          last: "Terakhir",
        },
      },
    });

    // Handle submit grup baru
    $("#groupForm").on("submit", function (e) {
      e.preventDefault();
      $.post(
        "/contact-groups/add",
        {
          name: $("#groupName").val(),
        },
        function () {
          $("#groupName").val("");
          loadGroups();
        }
      );
    });

    // Handle hapus grup
    $("#groupList").on("click", ".delete-group", function (e) {
      e.stopPropagation();
      const groupId = $(this).data("id");
      if (confirm("Hapus grup ini? Semua kontak dalam grup akan dihapus.")) {
        $.ajax({
          url: "/contact-groups/delete/" + groupId,
          type: "DELETE",
          success: function () {
            loadGroups();
            if ($("#group_id").val() == groupId) {
              $("#contactSection").hide();
              $("#noGroupSelected").show();
            }
          },
        });
      }
    });

    // Tambahkan fungsi pencarian grup
    $("#groupSearch").on("input", function () {
      const searchTerm = $(this).val().toLowerCase();
      $(".group-item").each(function () {
        const groupName = $(this).find("span").text().toLowerCase();
        if (groupName.includes(searchTerm)) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    });

    // Load grup saat halaman dimuat
    loadGroups();

    // Ubah handler submit form
    $("#phoneBookForm").on("submit", function (e) {
      e.preventDefault();
      const formData = {
        edit_id: $("#edit_id").val(),
        name: $("#name").val(),
        country_code: $("#country_code").val(),
        phone: $("#phone").val(),
        group_id: $("#group_id").val() // Tambahkan group_id ke formData
      };

      const isUpdate = $("#edit_id").val() !== "";
      const url = isUpdate ? "/phonebook/update" : "/phonebook/add";

      $.ajax({
        url: url,
        type: "POST",
        data: formData,
        success: function (response) {
          // Reset form
          $("#phoneBookForm")[0].reset();
          $("#edit_id").val("");
          $(".btn-primary").html('<i class="fas fa-plus"></i> Tambah');
          $("#country_code").val("62").trigger("change");

          // Refresh tabel
          $("#phoneBookTable").DataTable().ajax.reload();
        },
        error: function (xhr, status, error) {
          alert("Terjadi kesalahan: " + error);
        },
      });
    });

    // Handle Edit Button Click
    $("#phoneBookTable").on("click", ".btn-edit", function () {
      var id = $(this).data("id");
      $.get("/phonebook/" + id, function (data) {
        $("#name").val(data.name);

        // Perbaikan ekstraksi kode negara tanpa tanda +
        let phone = data.phone;
        let countryCode = data.country_code;

        $("#phone").val(phone);
        $("#country_code").val(countryCode).trigger("change");
        $("#edit_id").val(data.id);
        $(".btn-primary").html('<i class="fas fa-save"></i> Update');
      });
    });

    // Handle Delete Button Click
    $("#phoneBookTable").on("click", ".btn-delete", function () {
      var id = $(this).data("id");
      if (confirm("Apakah Anda yakin ingin menghapus kontak ini?")) {
        $.ajax({
          url: "/phonebook/delete/" + id,
          type: "DELETE",
          success: function (result) {
            table.ajax.reload();
          },
        });
      }
    });

    // Format nomor telepon saat input
    $("#phone").on("input", function () {
      $(this).val(
        $(this)
          .val()
          .replace(/[^0-9]/g, "")
      );
    });
  });
</script>
